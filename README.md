<h1 align="left">protobuf-rs</h1>
<p align="right"><a href="https://dropbox.tech/">by <img src="https://www.dropbox.com/s/vwygq2i9gmx60bz/dropbox_small.png?raw=1" width="32" height="32"/></a></p>

`pb-rs` is a protobuf code generation framework for the Rust language developed at Dropbox.

This implementation was initially written in 2016 to satisfy the need of shuffling large amount
of bytes in [Dropbox's Storage System (Magic Pocket)](https://dropbox.tech/infrastructure/inside-the-magic-pocket).
Previously, we were using [`rust-protobuf`](https://github.com/stepancheg/rust-protobuf) (and therefore generated code looks exactly
like that to make it easy to migrate), but serializing Rust structs to proto messages and then serializing them in
our RPC layer meant multiple copies (and same thing in reverse on parsing stack). Taking control of this
implementation and integrating it in our RPC stack end-to-end helped avoid extra copies.

Over the years, the implementation has grown and matured and is used in several parts of Dropbox, including
our [Sync Engine](https://dropbox.tech/infrastructure/rewriting-the-heart-of-our-sync-engine)

Other implementations exist in the rust ecosystem (eg [`prost`](https://github.com/danburkert/prost)), and
we wanted to share ours as well.

# Features
- Scalable - generates separate crates per module, with option for crate-per-directory
- Closed structs with public fields
- Autogenerates Cargo.toml, or optionally Spec.toml / bazel BUILD files
- Supports generating non-nullable fields types with `(gogoproto.nullable)=false`
- Supports generating `Box<Message>` field types with `(rust.box_it)=true`
- Automatically boxes messages if it finds a recursive message definition
- Supports generating custom field type with `(rust.type)="type"`
- Supports generating oneofs as non-nullable (fail on deserialization) type with `(rust.nullable)=false`
- Supports generating enums as non-zeroable (fail on deserialization) type with `(rust.err_if_default_or_unknown)=true`
- Supports generating serde serializable/deserializable messages with file level `(rust.serde_derive)=true`
- Supports preserving unrecognized proto fields into `_unrecognized` struct field with `(rust.preserve_unrecognized)=true`
  - Defaults to false - to eliminate serde dependency
- capability for zero-copy deserialization (examples coming soon)
- service generation (coming soon)

# Upcoming
Some of the features here require additional tooling to be useful, which are not yet public.
- Spec.toml is a stripped down templated Cargo.toml - which you can script convert into
    Cargo.toml in order to get consistent dependency versions in a multi-crate project.
    Currently, the script to convert Spec.toml -> Cargo.toml isn't yet available
- Autogenerated BUILD files require additional tooling to convert `BUILD.in-gen-proto~` to a BUILD file

Closed structs with public fields
- Adding fields to a proto file will lead to compiler errors. This can be a benefit in that it allows the
compiler to identify all callsites that may need to be visited. However, it can make updating protos with
many callsites a bit tedious. We opted to go this route to make it easier to add a new field and update
all callsites with assistance from the compiler.

# Contributing

First contributions are __greatly__ appreciated and highly encouraged. For legal reasons all outside 
contributors must agree to [Dropbox's CLA](https://opensource.dropbox.com/cla/). Thank you for
your understanding.


# Running the `pbtest` unit tests

1. Clone Repo.
2. Install Dependencies / Testing Dependencies. These instructions are for OSX using the brew
   package manager. Use the appropriate package manager for your system.
    - protoc - part of Google's [protobuf tools](https://github.com/protocolbuffers/protobuf/)	
        - `brew install protobuf`
    - Install Go
        - `brew install go`
    - Install [gogoproto](https://github.com/gogo/protobuf)
        - `go get github.com/gogo/protobuf/proto`	
    - Install Python & dependencies
        - `brew install python3`
        - `pip install six`
        - `pip install protobuf`
    - Generate test protos
        - On OSX: you'll have to install coreutils for realpath `brew install coreutils`
        - `./gen_protos.sh`
3. **pb-rs** currently uses an experimental test framework that requires a nightly build of rust.
	-  `rustup default nightly`
4. `cargo test`


### TODO - before open sourcing

- [x] Get onto github
- [x] Get lib compiling
- [x] Get tests compiling
- [x] Add critical protos (eg rust.proto for extensions)
- [x] Move pbtest into tests/ directory per traditional rust testing design
- [x] Add pbtest protos
- [x] Get protos compiling somehow for tests
- [x] Document features of this implementation
- [x] Add open source license (Apache 2.0) and Copyright attribution `"Copyright (c) 2020 Dropbox, Inc."` - http://www.apache.org/licenses/LICENSE-2.0
- [x] Credit other Dropboxers that have contributed to pb-rs development (look at git log)
- [x] Link to CLA for outside contributions https://opensource.dropbox.com/cla/
- [x] Document why it exists (vs the standard open source proto options)
- [x] Make extensions.proto and servicepb.proto proto3
- [x] Remove references to dbx specific stuff
- [ ] Add examples to README
- [ ] remove this section from the README
- [ ] Add requirements.txt for python dependencies

### TODO

- [ ] Document and add tests for `grpc_slices`
- [ ] Add `custom_type` example to pbtest
- [ ] Mypy the codegen.py in CI
- [ ] rustfmt in CI
- [ ] Add service generation codegen as well
- [ ] Rename pbtest.proto to pbtest2.proto
- [ ] Add blob crate / zerocopy
- [ ] run benchmarks against zerocopy blob impl
- [ ] Create github issues for remaining todos
- [ ] Add travis-ci integration
- [ ] Run mypy-protobuf for the tests - to better mypy codegen.py
- [ ] Autogenerate warn on rust 2018 idioms
- [ ] Add test files w/ multiple generated crates that depend on each other
- [ ] Figure out how to host documentation somewhere
- [ ] Bonus: Port over the test which serializes in go and deserializes/reserializes in rust
- [ ] Bonus: Python3
- [ ] Create helper library similar to `prost_build`
- [ ] Open source oxidize (or something of the sort)

## Contributors

### Dropboxers
- [@nipunn1313](https://github.com/nipunn1313)
- [@rajatgoel](https://github.com/rajatgoel)
- [@rbtying](https://github.com/rbtying)
- [@goffrie](https://github.com/goffrie)
- [@euroelessar](https://github.com/euroelessar)
- [@bradenaw](https://github.com/bradenaw)
- [@aaronp]
- [@jiayixu](https://github.com/jiayixu)
- [@dyv](https://github.com/dyv)
- [@joshuawarner32](https://github.com/joshuawarner32)
- [@peterlvilim](https://github.com/peterlvilim)
- [@ddeville](https://github.com/ddeville)
- [@isho](https://github.com/isho)
- [@ParkMyCar](https://github.com/ParkMyCar)

## Similar Projects
[`rust-protobuf`](https://github.com/stepancheg/rust-protobuf) - Rust implementation of Google protocol buffers <br />
[`prost`](https://github.com/danburkert/prost) - PROST! a Protocol Buffers implementation for the Rust Language <br />
[`quick-protobuf`](https://github.com/tafia/quick-protobuf) - A rust implementation of protobuf parser <br />
[`serde-protobuf`](https://github.com/dflemstr/serde-protobuf)
